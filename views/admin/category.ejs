<%- include("../../views/partials/admin/header") %>



<% if (success && success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (error && error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="container mt-5 pt-5">
  <!-- Heading + Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Category Management</h3>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
      <i class="fas fa-plus me-2"></i> Add Category
    </button>
  </div>

  <!-- Search Form -->
  <form class="d-flex mb-4" method="GET" action="/admin/category">
    <input 
      type="text" 
      name="search" 
      class="form-control me-2" 
      placeholder="Search Category..." 
      value="<%= typeof search !== 'undefined' ? search : '' %>"
    />
    <button type="submit" class="btn btn-primary me-2">Search</button>
    <a href="/admin/category" class="btn btn-secondary">Clear</a>
  </form>
</div>

<!-- Categories Table -->
<table class="table table-hover">
  <thead>
    <tr>
      <th>Category Name</th>
      <th>Description</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <% if(categories.length > 0) { %>
      <% categories.forEach(category => { %>
        <tr>
          <td><%= category.name %></td>
          <td><%= category.description %></td>
          <td>
            <% if(category.isListed) { %>
              <a href="/admin/category/unlist/<%= category._id %>" class="btn btn-success btn-sm">Listed</a>
            <% } else { %>
              <a href="/admin/category/list/<%= category._id %>" class="btn btn-danger btn-sm">Unlisted</a>
            <% } %>
          </td>
          <td>
            <!-- Edit Button -->
            <button 
              type="button" 
              class="btn btn-warning btn-sm editBtn"
              data-id="<%= category._id %>"
              data-name="<%= category.name %>"
              data-description="<%= category.description %>"
              data-bs-toggle="modal" 
              data-bs-target="#editCategoryModal">
              Edit
            </button>

            <!-- Delete Button -->
          <button 
  class="btn btn-danger btn-sm deleteBtn" 
  data-id="<%= category._id %>" 
  data-bs-toggle="modal" 
  data-bs-target="#deleteCategoryModal">
  Delete
</button>

          </td>
        </tr>
      <% }) %>
    <% } else { %>
      <tr>
        <td colspan="5" class="text-center">No categories found</td>
      </tr>
    <% } %>
  </tbody>
</table>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <% if(currentPage > 1) { %>
      <li class="page-item">
        <a class="page-link" href="/admin/category?page=<%= currentPage - 1 %><%= search ? '&search=' + search : '' %>">Previous</a>
      </li>
    <% } %>

    <% for(let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
        <a class="page-link" href="/admin/category?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
      </li>
    <% } %>

    <% if(currentPage < totalPages) { %>
      <li class="page-item">
        <a class="page-link" href="/admin/category?page=<%= currentPage + 1 %><%= search ? '&search=' + search : '' %>">Next</a>
      </li>
    <% } %>
  </ul>
</nav>

<!-- Add Category Modal -->



<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/admin/category" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryLabel">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="categoryName" name="name" >
            <div class="text-danger small mt-1" id="nameError"></div>
          </div>
          <div class="mb-3">
            <label for="categoryDesc" class="form-label">Description</label>
            <textarea class="form-control" id="categoryDesc" name="description" rows="3"></textarea>
              <div class="text-danger small mt-1" id="descError"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editCategoryForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="editCategoryLabel">Edit Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="editCategoryName" name="name" >
             <div class="text-danger small mt-1" id="editnameError"></div>
          </div>
          <div class="mb-3">
            <label for="editCategoryDesc" class="form-label">Description</label>
            <textarea class="form-control" id="editCategoryDesc" name="description" rows="3"></textarea>
              <div class="text-danger small mt-1" id="editdescError"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update Category</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCategoryLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this category?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteCategoryForm" method="POST">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Prefill Edit Modal JS -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.editBtn');
    const editForm = document.getElementById('editCategoryForm');
    const nameInput = document.getElementById('editCategoryName');
    const descInput = document.getElementById('editCategoryDesc');
    const nameError=document.getElementById('editnameError')
    const descError=document.getElementById('editdescError')
  
editForm.addEventListener('submit',function(e){
  let valid=true
editnameError.textContent=''
editdescError.textContent=''
if(nameInput.value.trim()==='')
{
  editnameError.textContent = 'Category name is required';
  valid=false
}

    if (descInput.value.trim() === '') {
      editdescError.textContent = 'Description is required';
      valid = false;
    }
 if (!valid) e.preventDefault();
  })

    editButtons.forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.id;
        const name = button.dataset.name;
        const description = button.dataset.description;

        nameInput.value = name;
        descInput.value = description;
        editForm.action = `/admin/category/edit/${id}`;
      });
    });
  });





</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.deleteBtn');
    const deleteForm = document.getElementById('deleteCategoryForm');

    deleteButtons.forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.id;
        deleteForm.action = `/admin/category/delete/${id}`;
      });
    });
  });
</script>
<script>
const addForm=document.querySelector('#addCategoryModal form')
const nameInput=document.getElementById('categoryName')
const descInput=document.getElementById('categoryDesc')
const nameError=document.getElementById('nameError')
const descError=document.getElementById('descError')

addForm.addEventListener('submit',function(e){
  let valid=true
nameError.textContent=''
descError.textContent=''
if(nameInput.value.trim()==='')
{
  nameError.textContent = 'Category name is required';
  valid=false
}

    if (descInput.value.trim() === '') {
      descError.textContent = 'Description is required';
      valid = false;
    }
 if (!valid) e.preventDefault();
  })


</script>




<%- include("../../views/partials/admin/footer") %>
